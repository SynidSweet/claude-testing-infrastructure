name: Core Infrastructure Tests

on:
  push:
    branches: [ main, develop, feature/*, fix/* ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'

jobs:
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [18, 20]
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build infrastructure
        run: npm run build

      - name: Verify CLI availability
        run: |
          echo "Testing CLI availability..."
          CLI_OUTPUT=$(node dist/cli/index.js --version)
          echo "CLI output: $CLI_OUTPUT"
          
          # Extract version number
          CLI_VERSION=$(echo "$CLI_OUTPUT" | tail -n 1)
          echo "‚úÖ CLI version: $CLI_VERSION"

      - name: Run lint checks
        run: npm run lint

      - name: Run format checks
        run: npm run format:check

      - name: Run core tests
        run: npm test
        env:
          CI: true  # This ensures AI tests are automatically skipped via Jest config

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-results-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            coverage/
            test-results/
            *.log

  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build infrastructure
        run: npm run build

      - name: Generate coverage report
        run: npm run test:coverage
        env:
          CI: true

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      - name: Comment coverage on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (fs.existsSync('coverage/lcov-report/index.html')) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## üìä Test Coverage Report\n\nCore infrastructure test coverage report has been generated. Check the workflow artifacts for detailed coverage information.\n\n> **Note**: AI validation tests are excluded from CI runs to maintain fast feedback loops. Run tests locally for comprehensive validation.`
              });
            }

  quality-checks:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build infrastructure
        run: npm run build

      - name: Run comprehensive quality checks
        run: |
          echo "üîç Running quality checks..."
          
          # Check for TypeScript compilation errors
          npx tsc --noEmit
          
          # Verify all core modules can be imported
          node -e "
            const analyzer = require('./dist/analyzers/ProjectAnalyzer');
            const generator = require('./dist/generators/TestGenerator');
            const runner = require('./dist/runners/TestRunnerFactory');
            console.log('‚úÖ All core modules imported successfully');
          "
          
          # Test CLI functionality
          echo "Testing CLI commands..."
          node dist/cli/index.js --help > /dev/null
          node dist/cli/index.js --version > /dev/null
          echo "‚úÖ CLI commands functional"

      - name: Validate configuration
        run: |
          echo "üîß Validating configuration system..."
          node -e "
            const config = require('./dist/config/ConfigurationService');
            console.log('‚úÖ Configuration system validated');
          "

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level moderate

      - name: Check for vulnerable dependencies
        run: |
          echo "üîí Checking for security vulnerabilities..."
          npm audit --audit-level high --dry-run || echo "‚ö†Ô∏è High-severity vulnerabilities found"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [test, coverage, quality-checks, security]
    if: always()
    
    steps:
      - name: Generate CI summary
        run: |
          echo "# üöÄ CI Pipeline Summary" > ci-summary.md
          echo "**Workflow**: ${{ github.workflow }}" >> ci-summary.md
          echo "**Run ID**: ${{ github.run_id }}" >> ci-summary.md
          echo "**Trigger**: ${{ github.event_name }}" >> ci-summary.md
          echo "**Branch**: ${{ github.ref_name }}" >> ci-summary.md
          echo "" >> ci-summary.md
          
          echo "## Job Results" >> ci-summary.md
          echo "- **Core Tests**: ${{ needs.test.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}" >> ci-summary.md
          echo "- **Coverage**: ${{ needs.coverage.result == 'success' && '‚úÖ Generated' || needs.coverage.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}" >> ci-summary.md
          echo "- **Quality Checks**: ${{ needs.quality-checks.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}" >> ci-summary.md
          echo "- **Security Scan**: ${{ needs.security.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}" >> ci-summary.md
          echo "" >> ci-summary.md
          
          echo "## Test Configuration" >> ci-summary.md
          echo "- **AI Tests**: Automatically skipped in CI (run locally for full validation)" >> ci-summary.md
          echo "- **Platforms**: Ubuntu, macOS" >> ci-summary.md
          echo "- **Node Versions**: 18, 20" >> ci-summary.md
          echo "" >> ci-summary.md
          
          # Determine overall status
          OVERALL_STATUS="‚úÖ ALL CHECKS PASSED"
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            OVERALL_STATUS="‚ùå FAILED - Core tests failed"
          elif [[ "${{ needs.quality-checks.result }}" != "success" ]]; then
            OVERALL_STATUS="‚ùå FAILED - Quality checks failed"
          elif [[ "${{ needs.security.result }}" != "success" ]]; then
            OVERALL_STATUS="‚ö†Ô∏è WARNING - Security issues detected"
          fi
          
          echo "## Overall Status: $OVERALL_STATUS" >> ci-summary.md
          
          cat ci-summary.md

      - name: Upload CI summary
        uses: actions/upload-artifact@v4
        with:
          name: ci-summary
          path: ci-summary.md

      - name: Set final status
        run: |
          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "‚ùå Core tests failed - failing CI"
            exit 1
          elif [[ "${{ needs.quality-checks.result }}" != "success" ]]; then
            echo "‚ùå Quality checks failed - failing CI"
            exit 1
          fi
          
          echo "‚úÖ CI pipeline completed successfully"